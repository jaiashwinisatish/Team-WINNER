# Plan: AI Agent Hardening — Wikipedia Search Tool Fix

## Objective

Fix the 9 distinct bugs in the `wikipediaSearchTool` implementation inside `answer-question-with-wikipedia.ts`. These bugs span malformed API URLs, swapped variable names, and incorrect data access patterns that make the tool completely non-functional.

## Requirements Addressed

- [ ] **AI-04**: Wikipedia search URL parameter corrected from `srch=` to `srsearch=`
- [ ] **AI-05**: Null-check on line 35 uses `searchResponse.query` instead of `searchData.query`
- [ ] **AI-06**: Line 39 references `searchResponse.query.search` instead of `searchData.query.search`
- [ ] **AI-07**: Loop variable on line 42 corrected from `searchTmkc` to `searchResults`
- [ ] **AI-08**: Wikipedia extract API URL on line 47 is malformed — missing `?action=query&titles=` segments
- [ ] **AI-09**: Line 48 `fetch(extractData)` uses wrong variable — should be `fetch(extractUrl)`
- [ ] **AI-10**: Line 49 `extractURL.json()` uses wrong variable — should be `extractResponse.json()`
- [ ] **AI-11**: Line 52 condition checks `extract` (empty string, always falsy) instead of `extractData`
- [ ] **AI-12**: Line 54 `extractData.query.pages.extract` should access by `pageId` — `extractData.query.pages[pageId].extract`

## Context Files

Read these before starting:
- @[.planning/STATE.md]
- @[src/ai/flows/answer-question-with-wikipedia.ts] — lines 27–68 (the tool handler)

## Tasks

<task name="fix_search_url" type="auto">
**What:** Fix the Wikipedia search API URL so it actually returns results.

**How:**
1. Open `src/ai/flows/answer-question-with-wikipedia.ts`
2. Line 29: change `srch=` to `srsearch=`
   - **Before:** `` `...&srch=${encodeURIComponent(query)}&srlimit=3` ``
   - **After:** `` `...&srsearch=${encodeURIComponent(query)}&srlimit=3` ``

**Files to modify:**
- `src/ai/flows/answer-question-with-wikipedia.ts` — line 29

**Done when:**
- [ ] Search URL uses `srsearch=` parameter (the correct Wikipedia API parameter name)
</task>

<task name="fix_search_response_variables" type="auto">
**What:** Fix the three places where `searchResponse` is incorrectly used instead of `searchData` to access the parsed JSON body.

**How:**
1. Line 35 null-check: `!searchResponse.query` → `!searchData.query`
   - **Before:** `if (!searchData || !searchResponse.query || !searchData.query.search || searchData.query.search.length === 0)`
   - **After:** `if (!searchData || !searchData.query || !searchData.query.search || searchData.query.search.length === 0)`
2. Line 39: `searchResponse.query.search` → `searchData.query.search`
   - **Before:** `const searchResults = searchResponse.query.search;`
   - **After:** `const searchResults = searchData.query.search;`

**Rationale:** `searchResponse` is the raw `fetch` Response object — it doesn't have a `.query` property. `searchData` is the variable holding the parsed JSON (line 33).

**Files to modify:**
- `src/ai/flows/answer-question-with-wikipedia.ts` — lines 35, 39

**Done when:**
- [ ] All parsed-JSON access uses `searchData`, not `searchResponse`
</task>

<task name="fix_loop_variable" type="auto">
**What:** Fix the `for...of` loop that iterates over a non-existent variable.

**How:**
1. Line 42: change `searchTmkc` to `searchResults`
   - **Before:** `for (const result of searchTmkc) {`
   - **After:** `for (const result of searchResults) {`

**Files to modify:**
- `src/ai/flows/answer-question-with-wikipedia.ts` — line 42

**Done when:**
- [ ] Loop iterates over the correctly named `searchResults` array
</task>

<task name="fix_extract_fetch_chain" type="auto">
**What:** Fix the entire extract-fetching block (lines 47–54) which has 5 distinct variable-swap bugs that form a broken chain.

**How:**
1. **Line 47 — Malformed URL:** The extract API URL is completely wrong. Fix:
   - **Before:** `` const extractUrl = `https://en.wikipedia.org/w/api.php=${encodeURIComponent(title)}&format=json&explaintext`; ``
   - **After:** `` const extractUrl = `https://en.wikipedia.org/w/api.php?action=query&prop=extracts&titles=${encodeURIComponent(title)}&format=json&explaintext&exintro`; ``
   - The URL was missing `?action=query&prop=extracts&titles=` — these are mandatory Wikipedia API parameters.

2. **Line 48 — Wrong fetch argument:** `fetch(extractData)` should be `fetch(extractUrl)`.
   - **Before:** `const extractResponse = await fetch(extractData);`
   - **After:** `const extractResponse = await fetch(extractUrl);`
   - `extractData` doesn't even exist yet at this point (it's declared on the next line).

3. **Line 49 — Wrong .json() target:** `extractURL.json()` should be `extractResponse.json()`.
   - **Before:** `const extractData: any = await extractURL.json();`
   - **After:** `const extractData: any = await extractResponse.json();`

4. **Line 52 — Wrong condition:** Checks `extract` (an empty string = falsy) instead of `extractData`.
   - **Before:** `if (extract && extractData.query && extractData.query.pages) {`
   - **After:** `if (extractData && extractData.query && extractData.query.pages) {`

5. **Line 54 — Missing pageId bracket access:**
   - **Before:** `extract = extractData.query.pages.extract || '';`
   - **After:** `extract = extractData.query.pages[pageId].extract || '';`
   - Pages are keyed by their numeric page ID, not directly accessible as `.extract`.

**Files to modify:**
- `src/ai/flows/answer-question-with-wikipedia.ts` — lines 47–54

**Verification:**
```bash
npx tsc --noEmit src/ai/flows/answer-question-with-wikipedia.ts 2>&1 | head -30
```

**Done when:**
- [ ] Extract URL is a valid Wikipedia API query with `action=query&prop=extracts&titles=`
- [ ] `fetch()` receives the URL string, not the data variable
- [ ] `.json()` is called on the response, not the URL
- [ ] Null-check tests `extractData`, not the empty `extract` string
- [ ] Page extract is accessed via `pages[pageId].extract`
</task>

## Success Criteria

At plan completion:
- [ ] All 9 requirement checkboxes above marked done
- [ ] The `wikipediaSearchTool` handler has a coherent variable chain: URL → fetch(URL) → response.json() → data
- [ ] Wikipedia search URL uses the correct `srsearch=` parameter
- [ ] Wikipedia extract URL is fully formed with `?action=query&prop=extracts&titles=`
- [ ] No undefined/wrong-variable references remain in the tool handler
- [ ] TypeScript compiles without errors in the tool function

## Commit Message Template

```
fix(ai): repair Wikipedia search tool logic

03-02: Fix 9 variable-swap and malformed-URL bugs in search tool

Requirements: AI-04, AI-05, AI-06, AI-07, AI-08, AI-09, AI-10, AI-11, AI-12
```
