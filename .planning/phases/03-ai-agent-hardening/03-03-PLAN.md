# Plan: AI Agent Hardening — Schema, Flow & Prompt Restoration

## Objective

Define the missing input schema, fix the broken output schema syntax, repair the `ai.defineFlow` call, and create the `wikipediaAnswerPrompt` that the flow depends on — completing the end-to-end AI pipeline.

## Requirements Addressed

- [ ] **AI-13**: `AnswerQuestionWithWikipediaInputSchema` is referenced but never defined — must be defined with a `question: z.string()` field
- [ ] **AI-14**: Output schema on line 74 is missing opening `({` — has `z.object` without parenthesis
- [ ] **AI-15**: Output schema fields labeled `(BROKEN)` — descriptions should describe the actual purpose
- [ ] **AI-16**: Output schema missing closing `});`
- [ ] **AI-17**: `ai.defineFlow` on line 81 is missing opening `({` parenthesis
- [ ] **AI-18**: Flow definition is missing closing `);`
- [ ] **AI-19**: `wikipediaAnswerPrompt` is referenced (line 87) but never defined — must create the prompt using `ai.definePrompt`

## Context Files

Read these before starting:
- @[.planning/STATE.md]
- @[.planning/ROADMAP.md]
- @[src/ai/flows/answer-question-with-wikipedia.ts] — lines 72–93
- @[src/ai/genkit.ts] — for the `ai` instance

## Tasks

<task name="define_input_schema" type="auto">
**What:** Create the missing `AnswerQuestionWithWikipediaInputSchema` that is referenced on lines 72, 84, and 91 but never defined.

**How:**
1. Open `src/ai/flows/answer-question-with-wikipedia.ts`
2. After line 18 (after the tool output schema definitions), add:

```typescript
const AnswerQuestionWithWikipediaInputSchema = z.object({
  question: z.string().describe('The question to answer using Wikipedia.'),
});
```

3. This must be placed **before** line 72 where the type alias references it.

**Files to modify:**
- `src/ai/flows/answer-question-with-wikipedia.ts` — add new schema after line 18

**Done when:**
- [ ] `AnswerQuestionWithWikipediaInputSchema` is defined with a `question: z.string()` field
- [ ] The type alias on line 72 resolves without error
</task>

<task name="fix_output_schema" type="auto">
**What:** Fix the broken output schema — it's missing parentheses, has sabotaged descriptions, and lacks closing syntax.

**How:**
1. Replace the broken output schema block (lines 74–77) with:

```typescript
const AnswerQuestionWithWikipediaOutputSchema = z.object({
  text: z.string().describe('The answer text generated from Wikipedia content.'),
  urls: z.array(z.string()).describe('Source URLs from Wikipedia articles used.'),
});
```

**Key fixes:**
- Line 74: `z.object` → `z.object({` (add opening parenthesis and brace)
- Line 75: Remove `(BROKEN)` from description, fix description text
- Line 76: Remove `(BROKEN)` from description, fix description text
- Line 77: Add closing `});`

**Files to modify:**
- `src/ai/flows/answer-question-with-wikipedia.ts` — lines 74–77

**Done when:**
- [ ] Output schema has correct `z.object({...})` syntax
- [ ] Field descriptions are accurate (not labeled "BROKEN")
- [ ] Schema closes with `});`
</task>

<task name="fix_flow_definition" type="auto">
**What:** Fix the `ai.defineFlow` call which is missing its opening parentheses and closing syntax.

**How:**
1. Replace the broken flow block (lines 81–89) with:

```typescript
const answerQuestionWithWikipediaFlow = ai.defineFlow(
  {
    name: 'answerQuestionWithWikipediaFlow',
    inputSchema: AnswerQuestionWithWikipediaInputSchema,
    outputSchema: AnswerQuestionWithWikipediaOutputSchema,
  },
  async (input) => {
    const { output } = await wikipediaAnswerPrompt(input);
    return output!;
  }
);
```

**Key fixes:**
- Line 81: `ai.defineFlow` → `ai.defineFlow(` (add opening parenthesis)
- Line 82: Add opening `{` for config object
- Line 89: Add closing `);` for `defineFlow` call

**Files to modify:**
- `src/ai/flows/answer-question-with-wikipedia.ts` — lines 81–89

**Done when:**
- [ ] `ai.defineFlow(` has matching opening `(` and closing `);`
- [ ] Config object has matching `{` and `}`
- [ ] Flow handler function is properly wrapped
</task>

<task name="create_wikipedia_prompt" type="auto">
**What:** Create the `wikipediaAnswerPrompt` using `ai.definePrompt`. This is the core AI prompt that instructs the model to answer a question using Wikipedia search results.

**How:**
1. After the tool schemas (and before the flow definition), add the prompt definition:

```typescript
const wikipediaAnswerPrompt = ai.definePrompt(
  {
    name: 'wikipediaAnswerPrompt',
    tools: [wikipediaSearchTool],
    input: {
      schema: AnswerQuestionWithWikipediaInputSchema,
    },
    output: {
      schema: AnswerQuestionWithWikipediaOutputSchema,
    },
  },
  `You are a helpful assistant that answers questions using Wikipedia.

Given the user's question, use the wikipediaSearch tool to find relevant Wikipedia articles.
Read the article extracts carefully, then provide a comprehensive answer.

Your response must include:
- "text": A clear, factual answer based on the Wikipedia content. Cite information accurately.
- "urls": An array of the Wikipedia page URLs you used as sources.

User's question: {{question}}`
);
```

**Design decisions:**
- The prompt registers `wikipediaSearchTool` so the model can call it autonomously
- Input/output schemas match the flow's schemas for type safety
- The template uses `{{question}}` handlebars syntax (Genkit's dotprompt convention)
- Instructions emphasize factual answers with source attribution

**Files to modify:**
- `src/ai/flows/answer-question-with-wikipedia.ts` — add prompt definition between tool and flow

**Done when:**
- [ ] `wikipediaAnswerPrompt` is defined using `ai.definePrompt`
- [ ] Prompt includes `wikipediaSearchTool` in its tools array
- [ ] Input/output schemas match the flow schemas
- [ ] Prompt template instructs the model to answer using Wikipedia and return `text` + `urls`
</task>

<task name="verify_end_to_end" type="checkpoint:human-verify">
**What to verify:**
- The complete `answer-question-with-wikipedia.ts` file compiles without TypeScript errors
- The flow chain is complete: input → prompt (with tool) → output
- All imports are valid

**How to verify:**
1. Run TypeScript compilation check:
```bash
npx tsc --noEmit
```
2. Visually inspect the file structure — it should follow this order:
   1. Imports
   2. Tool schemas (input/output)
   3. `wikipediaSearchTool` definition
   4. `AnswerQuestionWithWikipediaInputSchema`
   5. `AnswerQuestionWithWikipediaOutputSchema`
   6. Type exports
   7. `wikipediaAnswerPrompt` definition
   8. `answerQuestionWithWikipediaFlow` definition
   9. `answerQuestionWithWikipedia` exported wrapper function

If approved, Phase 3 is complete. If issues, fix before committing.
</task>

## Success Criteria

At plan completion:
- [ ] All 7 requirement checkboxes above marked done
- [ ] `AnswerQuestionWithWikipediaInputSchema` defined with `question: z.string()`
- [ ] Output schema has valid `z.object({...})` syntax
- [ ] `ai.defineFlow(...)` has correct parentheses and closing
- [ ] `wikipediaAnswerPrompt` is fully defined with tool, schemas, and template
- [ ] Full file compiles with `npx tsc --noEmit`
- [ ] The flow chain is complete: question → search → extract → AI answer → `{text, urls}`

## Commit Message Template

```
feat(ai): define schemas, flow, and prompt for WikiAgent

03-03: Create input schema, fix output schema, repair flow syntax, build prompt

Requirements: AI-13, AI-14, AI-15, AI-16, AI-17, AI-18, AI-19
```
